
# Define a job that produces some fake data useful for
# repacker testing. The output is in Streamer format.

# Original Author   W. David Dagenhart    27 March 2007

process HLT = {

  include "FWCore/MessageLogger/data/MessageLogger.cfi"

  untracked PSet options = {
    untracked bool wantSummary = true
  }

  source  = EmptySource { }

  # ~3.0 GB output file = 1.5 MB events x 2290 events x 0.87,
  # where 0.87 is the compression factor empirically measured
  # for this fake data.  There is a problems with this.
  # On machines that are not the newest, the streamer
  # output module crashes when the file size goes over
  # 2 GB. We believe this is related to the system libraries
  # used for file I/O.  On a new sl4 64 bit machine and compiling
  # with -m32 option, the streamer output module runs to
  # completion and creates a 3 GB without crashing.     
  untracked PSet maxEvents = {
    untracked int32 input = 2290

    # ~2.0 GB output file = 1.5 MB per event x 1270 events
    # The actual output file size is closer to 1.7 GB because
    # of compression.
    # untracked int32 input = 1270
  }

  # This produces fake data to fill the events.  It is just
  # vectors full of random numbers.
  # ~1.5 MB event = 4 bytes x 2500 vector elements x 150 vectors.
  # Produces 150 branches, which is of order what we expect in data.
  # The bit mask is 2^24 - 1, this is used to set the top 8 bits
  # of each array element to zero.  Without use of this bit mask,
  # the bits are all randomly set.  The reason we care about this
  # is that we want the data to be smaller after compression
  # is run.  This is for two reasons.  First, it is more like real
  # data.  Second, ROOT has a bug that leaks memory badly when the
  # data does not compress well. Setting these bits to zero allows
  # enough compression to avoid the bug.  (The ROOT bug exists in
  # 1_4_0_pre1.  The bug was reported and the claim is that it was fixed
  # but I do not know when this fix will propagate to a release).
  module prod = StreamThingProducer {
    int32 array_size = 2500
    int32 instance_count = 150
    untracked bool apply_bit_mask = true
    untracked uint32 bit_mask = 16777215
  }

  # Set up 50 filter modules, each with its own path.  These
  # make filter decisions based on 50 independent random
  # number sequences and an accept rate configured below.
  # The TriggerResults object created in the event will store
  # the results of these filter modules.

  service = RandomNumberGeneratorService {

    PSet moduleSeeds = {
      untracked uint32 m1 = 1
      untracked uint32 m2 = 2
      untracked uint32 m3 = 3
      untracked uint32 m4 = 4
      untracked uint32 m5 = 5
      untracked uint32 m6 = 6
      untracked uint32 m7 = 7
      untracked uint32 m8 = 8
      untracked uint32 m9 = 9
      untracked uint32 m10 = 10
      untracked uint32 m11 = 11
      untracked uint32 m12 = 12
      untracked uint32 m13 = 13
      untracked uint32 m14 = 14
      untracked uint32 m15 = 15
      untracked uint32 m16 = 16
      untracked uint32 m17 = 17
      untracked uint32 m18 = 18
      untracked uint32 m19 = 19
      untracked uint32 m20 = 20
      untracked uint32 m21 = 21
      untracked uint32 m22 = 22
      untracked uint32 m23 = 23
      untracked uint32 m24 = 24
      untracked uint32 m25 = 25
      untracked uint32 m26 = 26
      untracked uint32 m27 = 27
      untracked uint32 m28 = 28
      untracked uint32 m29 = 29
      untracked uint32 m30 = 30
      untracked uint32 m31 = 31
      untracked uint32 m32 = 32
      untracked uint32 m33 = 33
      untracked uint32 m34 = 34
      untracked uint32 m35 = 35
      untracked uint32 m36 = 36
      untracked uint32 m37 = 37
      untracked uint32 m38 = 38
      untracked uint32 m39 = 39
      untracked uint32 m40 = 40
      untracked uint32 m41 = 41
      untracked uint32 m42 = 42
      untracked uint32 m43 = 43
      untracked uint32 m44 = 44
      untracked uint32 m45 = 45
      untracked uint32 m46 = 46
      untracked uint32 m47 = 47
      untracked uint32 m48 = 48
      untracked uint32 m49 = 49
      untracked uint32 m50 = 50
    }
  }

  module m1 = RandomFilter { untracked double acceptRate = 0.2 }
  module m2 = RandomFilter { untracked double acceptRate = 0.2 }
  module m3 = RandomFilter { untracked double acceptRate = 0.2 }
  module m4 = RandomFilter { untracked double acceptRate = 0.2 }
  module m5 = RandomFilter { untracked double acceptRate = 0.2 }
  module m6 = RandomFilter { untracked double acceptRate = 0.1 }
  module m7 = RandomFilter { untracked double acceptRate = 0.1 }
  module m8 = RandomFilter { untracked double acceptRate = 0.1 }
  module m9 = RandomFilter { untracked double acceptRate = 0.1 }
  module m10 = RandomFilter { untracked double acceptRate = 0.1 }

  module m11 = RandomFilter { untracked double acceptRate = 0.05 }
  module m12 = RandomFilter { untracked double acceptRate = 0.05 }
  module m13 = RandomFilter { untracked double acceptRate = 0.05 }
  module m14 = RandomFilter { untracked double acceptRate = 0.05 }
  module m15 = RandomFilter { untracked double acceptRate = 0.05 }
  module m16 = RandomFilter { untracked double acceptRate = 0.05 }
  module m17 = RandomFilter { untracked double acceptRate = 0.05 }
  module m18 = RandomFilter { untracked double acceptRate = 0.05 }
  module m19 = RandomFilter { untracked double acceptRate = 0.05 }
  module m20 = RandomFilter { untracked double acceptRate = 0.05 }

  module m21 = RandomFilter { untracked double acceptRate = 0.01 }
  module m22 = RandomFilter { untracked double acceptRate = 0.01 }
  module m23 = RandomFilter { untracked double acceptRate = 0.01 }
  module m24 = RandomFilter { untracked double acceptRate = 0.01 }
  module m25 = RandomFilter { untracked double acceptRate = 0.01 }
  module m26 = RandomFilter { untracked double acceptRate = 0.01 }
  module m27 = RandomFilter { untracked double acceptRate = 0.01 }
  module m28 = RandomFilter { untracked double acceptRate = 0.01 }
  module m29 = RandomFilter { untracked double acceptRate = 0.01 }
  module m30 = RandomFilter { untracked double acceptRate = 0.01 }

  module m31 = RandomFilter { untracked double acceptRate = 0.005 }
  module m32 = RandomFilter { untracked double acceptRate = 0.005 }
  module m33 = RandomFilter { untracked double acceptRate = 0.005 }
  module m34 = RandomFilter { untracked double acceptRate = 0.005 }
  module m35 = RandomFilter { untracked double acceptRate = 0.005 }
  module m36 = RandomFilter { untracked double acceptRate = 0.005 }
  module m37 = RandomFilter { untracked double acceptRate = 0.005 }
  module m38 = RandomFilter { untracked double acceptRate = 0.005 }
  module m39 = RandomFilter { untracked double acceptRate = 0.005 }
  module m40 = RandomFilter { untracked double acceptRate = 0.005 }

  module m41 = RandomFilter { untracked double acceptRate = 0.001 }
  module m42 = RandomFilter { untracked double acceptRate = 0.001 }
  module m43 = RandomFilter { untracked double acceptRate = 0.001 }
  module m44 = RandomFilter { untracked double acceptRate = 0.001 }
  module m45 = RandomFilter { untracked double acceptRate = 0.001 }
  module m46 = RandomFilter { untracked double acceptRate = 0.0001 }
  module m47 = RandomFilter { untracked double acceptRate = 0.0001 }
  module m48 = RandomFilter { untracked double acceptRate = 0.0001 }
  module m49 = RandomFilter { untracked double acceptRate = 0.0001 }
  module m50 = RandomFilter { untracked double acceptRate = 0.0001 }

  path makeData = { prod }
  path p1 = { m1 }
  path p2 = { m2 }
  path p3 = { m3 }
  path p4 = { m4 }
  path p5 = { m5 }
  path p6 = { m6 }
  path p7 = { m7 }
  path p8 = { m8 }
  path p9 = { m9 }
  path p10 = { m10 }
  path p11 = { m11 }
  path p12 = { m12 }
  path p13 = { m13 }
  path p14 = { m14 }
  path p15 = { m15 }
  path p16 = { m16 }
  path p17 = { m17 }
  path p18 = { m18 }
  path p19 = { m19 }
  path p20 = { m20 }
  path p21 = { m21 }
  path p22 = { m22 }
  path p23 = { m23 }
  path p24 = { m24 }
  path p25 = { m25 }
  path p26 = { m26 }
  path p27 = { m27 }
  path p28 = { m28 }
  path p29 = { m29 }
  path p30 = { m30 }
  path p31 = { m31 }
  path p32 = { m32 }
  path p33 = { m33 }
  path p34 = { m34 }
  path p35 = { m35 }
  path p36 = { m36 }
  path p37 = { m37 }
  path p38 = { m38 }
  path p39 = { m39 }
  path p40 = { m40 }
  path p41 = { m41 }
  path p42 = { m42 }
  path p43 = { m43 }
  path p44 = { m44 }
  path p45 = { m45 }
  path p46 = { m46 }
  path p47 = { m47 }
  path p48 = { m48 }
  path p49 = { m49 }
  path p50 = { m50 }

  module out = EventStreamFileWriter
  {
    int32 max_event_size = 7000000
    int32 max_queue_depth = 5
    bool use_compression = true
    int32 compression_level = 1

    string fileName = "testRandomFilter.dat"
    string indexFileName = "testRandomFilter.ind"

    # I believe the rest of these are not relevant in
    # an offline job
    # untracked int32 numPerFile = 5

    #string filePath = "/whatever/whatever"
    #string mailboxPath = "/whatever/whatever"
    #string setupLabel = "whatever"
    #string streamLabel = "A"

    #int32 maxSize = 9000000000
    #double highWaterMark = 0.9
  }

  #module outp = PoolOutputModule
  #{
  #  untracked string fileName = "testRandomFilter.root"
  #}

  endpath o = { out }
}
